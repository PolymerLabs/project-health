<script>
  const CLIENT_ID = '23b7d82aec29a3a1a2a8';
  const REDIRECT_ORIGIN = window.location.origin;

  (function() {
    const queryParams = new URLSearchParams(window.location.search);

    if (queryParams.has('redirect-origin')) {
      // This redirect allows testing on localhost or on the remote server
      const redirectOauthURL = new URL(window.location.pathname, queryParams.get('redirect-origin'));

      // Remove the redirect origin and redirect with remaining search params
      queryParams.delete('redirect-origin');

      redirectOauthURL.search = queryParams.toString();
      window.location = redirectOauthURL.toString();
    } else if (queryParams.has('code')) {
      // User just logged in and we have the code from Github
      fetch('/api/login', {
        method: 'POST',
        body: queryParams.get('code'),
        credentials: 'include',
      }).then(() => {
        window.location.href =
          queryParams.get('final-redirect') || '/';
      });
    } else if(queryParams.has('error')) {
      // User logged in but there is an error from Github
      throw new Error(`Error returned by Github: '${queryParams.get('error_description')}'`);
    } else {
      const properties = {
        client_id: CLIENT_ID,
        scope: queryParams.get('scope') || '',
        redirect_uri: encodeURIComponent(
          `https://github-health.appspot.com/oauth.html?redirect-origin=${REDIRECT_ORIGIN}&final-redirect=${queryParams.get('final-redirect') || ''}`
        ),
      };
      const searchValues = Object.keys(properties).map((keyName) => {
        return `${keyName}=${properties[keyName]}`;
      });
      window.location = `https://github.com/login/oauth/authorize?${searchValues.join('&')}`;
    }
  })();
</script>
